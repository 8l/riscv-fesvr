#! /usr/bin/python

import os
import sys
from fesvr_htif import *
from fesvr_tmif import *

kernel = ''
for path in os.getenv('PATH').split(':'):
  test = path + '/riscv-pk'
  if os.access(test, os.F_OK):
    kernel = test
    break

if kernel == '':
  print "can't find riscv-pk in PATH"
  sys.exit(-1)

start = 1
for a in sys.argv[1:]:
  if len(a) > 1 and a[0] == '-':
    start = start+1
  else:
    break
htif_args = sys.argv[1:start]
args = sys.argv[start:]

if len(args) < 1:
  print "usage: %s bin [args]" % sys.argv[0]
  sys.exit(-1)

htif = htif_isasim_t(htif_args)
tmif = tmif_t(htif)

tmif.load_elf(kernel) # pk
tmif.load_elf(args[0]) # bin

target_argv = args
target_argc = len(target_argv)
tmif.mainvars_argc(target_argc)
for i in range(target_argc):
  tmif.mainvars_argv(i, len(target_argv[i]), target_argv[i])

tmif.start()

while True:
  mm = tmif.run_until_tohost()
  tmif.syscall(mm)
  tmif.write_fromhost(1)
